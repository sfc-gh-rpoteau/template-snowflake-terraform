name: terraform-plan-apply

on:
  pull_request:
    branches: [dev]
    paths:
      - "environments/dev/**"
      - "modules/**"

permissions:
  contents: read
  pull-requests: write
  id-token: write   # required for OIDC
  actions: read 
  # issues: write

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================
  # DETECT: Identify affected deployment directories
  # ============================================================
  detect:
    name: Detect Changes
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      deployment_dirs: ${{ steps.set-matrix.outputs.deployment_dirs }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Terraform version
        id: tf_version
        run: echo "TF_VERSION=$(cat .terraform-version)" >> $GITHUB_ENV

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v47

      - name: Build matrix from changed deployments
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          CHANGED="${{ steps.changed.outputs.all_changed_files }}"
          echo "Changed files: $CHANGED"

          # Run the deployment detection script
          # This handles both direct changes and module dependency changes
          deployment_dirs=$(.github/scripts/changed-deployments.sh "$CHANGED")

          echo "Deployment dirs JSON: $deployment_dirs"
          echo "deployment_dirs=$deployment_dirs" >> "$GITHUB_OUTPUT"

          # Check if we have any deployments to process
          if [[ "$deployment_dirs" == "[]" ]]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

  # ============================================================
  # LINT: Format check, TFLint, and Checkov security scan
  # ============================================================
  lint:
    name: Lint (${{ matrix.deployment_dir }})
    needs: detect
    if: needs.detect.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        deployment_dir: ${{ fromJson(needs.detect.outputs.deployment_dirs) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Terraform version
        run: echo "TF_VERSION=$(cat .terraform-version)" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ matrix.deployment_dir }}
        run: terraform fmt -check -recursive -diff
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        working-directory: ${{ matrix.deployment_dir }}
        run: tflint --init

      - name: Run TFLint
        id: tflint
        working-directory: ${{ matrix.deployment_dir }}
        run: tflint --format=compact --recursive
        continue-on-error: true

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ matrix.deployment_dir }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: true
          download_external_modules: true

      # - name: Upload Checkov SARIF
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: checkov-sarif-${{ hashFiles(matrix.deployment_dir) }}
      #     path: checkov-results.sarif
      #     retention-days: 5

      - name: Lint Summary
        if: always()
        run: |
          echo "## Lint Results for \`${{ matrix.deployment_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.fmt.outcome }}" == "success" ]]; then
            echo "✅ **Terraform Format**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Terraform Format**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ steps.tflint.outcome }}" == "success" ]]; then
            echo "✅ **TFLint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **TFLint**: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ steps.checkov.outcome }}" == "success" ]]; then
            echo "✅ **Checkov**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Checkov**: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Lint Status
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::error::Terraform format check failed. Run 'terraform fmt -recursive' to fix."
          exit 1